# Резюме проекта "ProbnikCZ_bot"

Этот документ содержит основные моменты и изменения, которые обсуждались для проекта Telegram-бота, использующего Aiogram и OpenAI API.

## Структура проекта

```
/ProbnikCZ_bot
│  ├─ main.py            # Точка входа. Здесь загружаются переменные окружения, инициализируется бот, регистрируются хендлеры и запускается polling.
│  ├─ .env               # Файл с переменными окружения (BOT_TOKEN, OPENAI_API_KEY, и т.д.)
│  ├─ requirements.txt   # Зависимости: aiogram==3.0.0b7, openai==0.27.0, python-dotenv==0.20.0, APScheduler==3.9.1.post1, и прочие.
│  ├─ /configs           # Конфигурационные файлы для языковых настроек (config_ru.json, config_en.json, и т.д.)
│  ├─ /gender_bot        # Файлы профилей для виртуального агента по гендеру:
│  │     ├─ bot_men.json      # Профиль виртуального парня-компаньона (для женщин)
│  │     └─ bot_woomen.json   # Профиль виртуальной девушки-компаньона (для мужчин)
│  ├─ /menusc            # Меню по языкам (в каждой папке по 3 файла JSON для Sushi, Grill, SETY)
│  ├─ /handlers          # Обработчики команд и сообщений
│  │     ├─ __init__.py       # Функция register_handlers для регистрации всех хендлеров.
│  │     ├─ start_handler.py  # Логика команды /start
│  │     ├─ menu_handler.py   # Логика команды /menu и обработка callback'ов меню.
│  │     ├─ language_handler.py # Логика смены языка
│  │     └─ common_handler.py  # Прочие команды (/support, /bots, /contacts, /website и fallback).
│  ├─ /services          # Бизнес-логика: работа с OpenAI API, рекомендации, загрузка конфигураций.
│  │     ├─ __init__.py
│  │     ├─ config_service.py  # Функции get_user_info, get_language, load_config, set_bot_commands.
│  │     ├─ openai_service.py  # Функции get_companion_system_prompt, ask_openai_companion.
│  │     └─ recommendation_service.py  # Логика рекомендаций из меню.
│  └─ /utils             # Вспомогательные функции и middleware.
│        ├─ __init__.py
│        └─ logging_middleware.py  # Middleware для логирования входящих сообщений.
```

## Основные моменты реализации

1. **Переменные окружения (.env):**  
   - Файл содержит ключи, такие как BOT_TOKEN и OPENAI_API_KEY.
   - Загружается с помощью `load_dotenv()` в main.py.

2. **Главный файл (main.py):**  
   - Инициализация бота, диспетчера, планировщика.
   - Регистрация всех хендлеров через функцию `register_handlers(dp)`.
   - Установка нативных команд через функцию `set_bot_commands(bot)`.
   - Запуск polling.

3. **Логика работы с OpenAI API (services/openai_service.py):**  
   - Функция `get_companion_system_prompt(user_id)`:
     - Выбирает профиль на основе гендера пользователя.
     - Сейчас настроено так, что для мужчин используется профиль из **bot_woomen.json** (виртуальная девушка), а для женщин – профиль из **bot_men.json** (виртуальный парень).
     - Логируются путь к файлу, содержимое JSON и сформированный промпт.
   - Функция `ask_openai_companion(prompt, user_id)`:
     - Формирует пользовательское сообщение.
     - Выполняет вызов OpenAI API через `asyncio.to_thread` для выполнения блокирующего запроса.
     - Логируется "сырой" ответ и финальное содержимое.

4. **Изменение логики выбора профиля:**  
   - Для изменения логики (например, если нужно инвертировать выбор профиля), достаточно изменить строку:
     ```python
     filename = "bot_woomen.json" if user.get("gender") == "male" else "bot_men.json"
     ```
   - Сейчас логика соответствует: если пользователь мужского пола, используется профиль для виртуальной девушки; если женского – профиль для виртуального парня.

5. **Логирование для диагностики:**  
   - Добавлено подробное логирование для отслеживания пути к файлам, содержимого JSON, сформированных промптов, сообщений и ответов от OpenAI.

## Дополнительные рекомендации

- **Модульная архитектура:**  
  Разделение кода по модулям (main.py, handlers, services, utils) помогает поддерживать проект и масштабировать его.

- **Сохранение проекта:**  
  Рекомендуется сохранять этот документ (например, в формате Markdown) для дальнейшей работы и напоминания ключевых моментов проекта.

---

Вы можете сохранить этот текст в файл, например, `chat_summary.md`. Просто скопируйте содержимое и вставьте в новый файл в любом текстовом редакторе, а затем сохраните с расширением `.md`.

Если потребуется дополнительная помощь или изменения, дайте знать!
